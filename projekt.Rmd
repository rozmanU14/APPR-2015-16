---
title: "Poročilo pri predmetu Analiza podatkov s programom R"
author: "Urška Rožman"
output:
  pdf_document:
    includes:
      in_header: lib/styles.sty
    latex_engine: xelatex
  html_document: default
  word_document: default
---

```{r setup, echo=FALSE, results='hide', message=FALSE,warning=FALSE}
# Če želimo nastaviti pisave v PDF-ju, odkomentiramo
# in sledimo navodilom v programu.
source("fontconfig.r", encoding = "UTF-8")

# Uvoz vseh potrebnih knjižnic
source("lib/libraries.r", encoding = "UTF-8")
```

# Izbira teme

Izbrala sem si temo z naslovom Analiza naravnega prirastka v Sloveniji in primerjava naravnega prirastka z drugimi Evropskimi državami. Analizirala bom rodnost, umrljivost in naravni prirastek v Sloveniji po regijah in spolu. V nadaljevanju pa ga bom primerjala s prirastkom v drugih Evropskih državah.

***

# Obdelava, uvoz in čiščenje podatkov

```{r uvoz, echo=FALSE,message=FALSE,warning=FALSE}
source("uvoz/uvoz.r", encoding = "UTF-8")
```

Podatke za prvo tabelo sem dobila na spletni strani statističnega urada Slovenije ter jih uvozila v CSV obliki, podatke za drugo tabelo pa sem v HTML obliki uvozila iz spletne strani EUROSTAT.

Povezave na podatke:
<http://ec.europa.eu/eurostat/web/population-demography-migration-projections/births-fertitily-data/database>
<http://pxweb.stat.si/pxweb/Dialog/varval.asp?ma=05I1002S&ti=&path=../Database/Dem_soc/05_prebivalstvo/25_selitveno_gibanje/05_05I10_naravno_gibanje/&lang=2>

Prva tabela vsebuje stolpce:

- ime kraja (imenska spremenljivka)
- leto (številska spremenljivka)
- število živorojenih moških (številska spremenljivka)
    - prikazuje rodnost moških po krajih in letih
- število živorojenih ženske (številska spremenljivka)
    - prikazuje rodnost žensk po krajih in letih
- število umrlih moških (številska spremenljivka)
    - prikazuje umrljivost moških po krajih in leti
- število umrlih žensk (številska spremenljivka)
    - prikazuje umrljivost žensk po krajih in letih
- naravni prirastek moških (številska spremenljivka)
    - prikazuje naravni prirastek moških po krajih in letih
- naravni prirastek žensk (številska spremenljivka)
    - prikazuje naravni prirastek moških po krajih in letih
- relativen naravni prirastek (številska spremenljivka)
- število urmlih na 1000 prebivalcev (šteilska spremenljivka)
- število živorojenih na 1000 prebivalcev (številska spremenljivka)


```{r razpredelnica1, echo=FALSE}
kable(head(tabela))
```


Te stolpce sem prečistila (mesta kjer ni bilo podatka sem zamenjala z NA), izbrisala nepotrebne stolpce in vrstice ter zagotovila, da bodo številske spremenljivke res številske. Tabelo sem ločila na pet pod tabel, ki so bile ločene glede na leto. Dodala sem stolpec "skupni.prirast" ki je seštevek naravnega prirasta moških in žensk. Da bi bilo filtriranje podatkov še lažje, sem dodala še stolpec "velikost" ki je urejenostna spremenljivka in sicer klasificira prirastek kot "pozitiven","negativen" oziroma "ni prirastka".

Druga tabela, ki je bila uvožena v HTML obliki vsebuje podatke o naravnem prirastku evropskih držav. Najprej sem uvozila zgolj podatke o prirastku ki so klicani z eno spremenljivko,ter jih dala v matriko, kasneje pa še podatke o letih merjenja ter državah. Ko sem prečistila nepotrebne podatke (zamenjava znakov "-","("b") z NA, ter pri vektorju držav in let napotrebne znake med željenimi državami) sem podatke, države in leta združila v eno tabelo. Ker želim analizirati le podatke od 2010-2013 sem ostale stolpce izbrisala. 

```{r razpredelnica2, echo=FALSE}
kable(head(podatkiHTML))
```

Nato sem narisala še nekaj grafov.

```{r graf1, echo=FALSE,fig.align='center',fig.cap='negativen.prirast.2010', warning=FALSE}
ggplot(data=tabela2010 %>% filter(velikost=="negativen"), aes(x=kraj, y=skupni.prirast)) +  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))+geom_point()


```
Prikazuje negativen prirast v letu 2010 po občinah.

```{r graf2, echo=FALSE,fig.align='center',fig.cap='pozitiven.prirast.2010'}
ggplot(data=tabela2010 %>% filter(velikost=="pozitiven"), aes(x=kraj, y=skupni.prirast)) +  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))+geom_point()


```
Prikazuje pozitiven prirast v letu 2010 po občinah.


```{r graf3, echo=FALSE,fig.align='center',fig.cap='ni.prirasta.2010'}
ggplot(data=tabela2010 %>% filter(velikost=="ni prirastka"), aes(x=kraj, y=skupni.prirast)) + geom_point()

```
Prikazuje občine v letu 2010, ki so brez prirastka.

***

# Analiza in vizualizacija podatkov
```{r vizualizacija, echo=FALSE,message=FALSE,warning=FALSE}
source("vizualizacija/analiza.3.faza.r", encoding = "UTF-8")
```

Preden sem začela z izdelavo zemljevidov sem v tabele občin dodala Ankaran, ki je novonastala občina, zato je v tabelah s podatki še ni bilo. Nato sem se lotila izdelave.

### Zemljevid naravnega prirasta po po občinah v Sloveniji v letu 2011
```{r zemljevid1, echo=FALSE, fig.align='center', fig.cap='Zemljevid naravnega prirastka v letu 2011'}
zem1<- ggplot() + geom_polygon(data = obc, aes(x = long, y = lat, group = group, fill = PRIRAST2011),color = "grey") +
  scale_fill_gradient(low="#d6b6ac", high="#090604") +
  guides(fill = guide_colorbar(title = "Naravni prirast 2011"))
  zem5<- zem1 +geom_text(data = obc %>% filter(OB_IME %in% c("DOL PRI LJUBLJANI","DRAVOGRAD","LJUBLJANA","MARIBOR")),
          aes(x = Y_C, y = X_C, label = OB_IME),          size = 3, vjust = 2, color="yellow")
print(zem5)
```
Zemljevid nam prikazuje naravni prirast v letu 2011 po občinah. Največji absolutni naravni prirast je v Ljubljani, najmanjši pa v Mariboru.
Največji relativni prirast je v občini Dol pri Ljublajni, najmanjši pa v Dravogradu.

```{r graf4, echo=FALSE,fig.align='center',fig.cap='skupni prirast'}
ggplot(tabela %>% filter(kraj %in% c("Dravograd", "Ljubljana", "Maribor","Dol pri Ljubljani")),aes(x = leto, y = naravni.prirast.na.1000.prebivalcev, group = kraj,color = kraj)) + geom_line()

```


### Zemljevid občin spozitivnim prirastom, negativnim prirastom in občin brez prirasta
```{r zemljevid2, echo=FALSE, fig.align='center', fig.cap='Zemljevid naravnega prirastka v letu 2011 z velikostmi'}
zem2<-zem1+ geom_point(data = obc , aes(x = Y_C, y = X_C, color = VELIKOST)) +
  scale_color_manual(name="Tip", breaks = c("POZITIVEN", "NEGATIVEN","NI PRIRASTKA"),
                     labels = c("POZITIVEN", "NEGATIVEN","NI PRIRASTKA"),
                     values = c("blue", "red","orange")) 
print(zem2)
```
Zemljevid prikazuje skupni prirast v letu 2011, s pikami pa je označena velikost prirasta. Modra pika prikazuje vse občine kjer je prirast pozitiven, rdeča tiste, kjer je negativen, rumena pa občine brez prirasta.

### Zemljevid umrlivosti v letu 2011
```{r zemljevid3, echo=FALSE, fig.align='center', fig.cap='Zemljevid umrlivosti 2011'}
zem3<-ggplot() + geom_polygon(data = obc, aes(x = long, y = lat, group = group, fill = UMRLIVOST2011),color = "grey") +
  scale_fill_gradient(low="#aefe57", high= "#344c1a") +
  guides(fill = guide_colorbar(title = "Umrlivost 2011")) +
  geom_text(data = obc %>% filter(OB_IME %in% c("BELTINCI","BRDA","LJUBLJANA","MARIBOR")),
          aes(x = Y_C, y = X_C, label = OB_IME),          size = 3, vjust = 2, color="black")
print(zem3)
```
Zemljevid prikazuje umrlivost po občinah v letu 2011 za moške in ženske skupaj. Največjo absolutno umrljivost ima Maribor, največjo relativno pa Brda.Najmanjšo absolutno umrlivost ima Ljubljana, najmanjšo relativno pa Beltinci.

### Analiza povprečnega naravnega prirasta po letih
Ugotovila sem, da je naravni prirast po letih od 2010 do 2013 padal,nato se 2014 spet narastel.
```{r graf5, echo=FALSE,fig.align='center',fig.cap='naravni prirast'}
ggplot(tabela %>% filter(kraj %in% c("Koper/Capodistria", "Ljubljana", "Maribor","Ptuj","Novo mesto")),
       aes(x = leto, y = skupni.prirast, group = kraj, color = kraj)) +
  geom_line()

```
Graf prikazuje gibanje naravnega prirasta v nekaj izmed izbranih občinah.

### Analiza živorojenih moških in žensk ločeno po letih

Ugotovila sem, da povprečnono število živorojenih žensk po letih pada, prav tako tudi število živorojenih moških. Vsako leto pa je število živorojenih moških večje od števila živorojenih žensk.

```{r graf6, echo=FALSE,fig.align='center',fig.cap='Zivorojene zenske'}
ggplot(tabela %>% filter(kraj %in% c("Koper/Capodistria", "Ljubljana", "Maribor","Ptuj","Novo mesto")),
       aes(x = kraj, y = zivorojene.zenske, fill = factor(leto))) +
    geom_bar(stat = "identity", position = "dodge")
ggplot(tabela %>% filter(kraj %in% c("Koper/Capodistria", "Ljubljana", "Maribor","Ptuj","Novo mesto")),
       aes(x = kraj, y = zivorojeni.moski, fill = factor(leto))) +
    geom_bar(stat = "identity", position = "dodge")
```
Prvi graf prikazuje gibanje števila živorojenih žensk v nekaj izmed izbranih občin, drugi pa gibanje števila živorojenih moških.

### Analiza umrlih moških in žensk ločeno po letih
Ugotovila sem, da v povprečju vsako leto umre več žensk kot moških. Podatki po letih so približno konstantni. Vsako leto pa je število umrlih ženske večje od števila umrlih moških.


```{r graf7, echo=FALSE,fig.align='center',fig.cap='umrlivost'}
ggplot(tabela %>% filter(kraj %in% c("Brda","Kobilje","Solcava")),aes(x = leto, y = umrli.na.1000, group = kraj, color = kraj)) +geom_line()

```
Na grafu so prikazane občine, ki po izračunanih vrednostih zajemajo najnižjo oziroma najvišjo smrtnost v enem izmed let od 2010 do 2014.

### Primerjava naravnega prirasta v Sloveniji z ostalimi Evropskimi državami

Ugotovila sem, da je imela največji povprečni naravni prirast v letu 2010 Islandija,v letih 2011-2013 pa Turčija.
Najmanjši navani prirast izmed Evropskih držav je imela v letih 2010 in 2011 Madžarska, v letu 2012 San marino, v letu 2013 pa Portugalska.
Ugotovila sem, da je povprečni slovenski prirast večji od povprečnega evropskega po letih.

***

```{r analiza, echo=FALSE,message=FALSE,warning=FALSE}
source("analiza/analiza.r", encoding = "UTF-8")
```

### Napredna analiza
V četrti fazi sem naredila model, ki prikazuje odvisnost dveh spremenljivk ter to analizirala. 

Graf prikazuje odvisnost naravnega prirasta moških od žensk. Iz grafa je razvidno da so podatki najbolj zgoščeni med vrednostmi -50 in 100, do največje razpršenosti podatkov pa pride pri večjih vrednostih. Za prikaz sem uporabila linearno metodo.

```{r graf8, echo=FALSE,fig.align='center',fig.cap='odvisnost naravnega prirastka med moškimi in ženskami', warning=FALSE}

j<- ggplot(tabela, aes(x = naravni.prirast.moski, y = naravni.prirast.zenske)) + geom_point()
j + geom_smooth(method = "lm")

```


### Napoved prirasta za Slovenijo

```{r graf9, echo=FALSE,fig.align='center',fig.cap='Napoved prirasta za Slovenijo', warning=FALSE}

nnaravni.prirast<-tabela$naravni.prirast.na.1000.prebivalcev
lleto<-tabela$leto
plot(lleto,nnaravni.prirast, xlim=c(2010,2020),ylim=c(-100,300),
     xlab="Leto",ylab="Naravni prirast na 1000 prebivalcev",
     main="Napoved naravnega prirast za Slovenijo",pch=20,col="lightblue",type="p",lwd=3.5)
linearna<-lm(nnaravni.prirast~lleto)
abline(linearna,col="red")
kvadratna<-lm(nnaravni.prirast~I(lleto^2)+lleto)
curve(predict(kvadratna, data.frame(lleto=x)), add = TRUE, col = "green")
loep<-loess(nnaravni.prirast~lleto)
curve(predict(loep, data.frame(lleto=x)),add=TRUE,col="blue")
legend("topright", c("Linerana metoda", "Kvadratna metoda","Loess"),lty=c(1,1,1), col = c("red","green","blue"))
```
Graf prikazuje napoved naravnega prirasta do leta 2020. Upobljene so linearna metoda, kvadratna ter metoda loess. 
Pri izračunu ostanov sem ugotovila, da je metoda loess najnatančnejša.

### Napoved rasti rodnosti
```{r graf10, echo=FALSE,fig.align='center',fig.cap='napoved rasti rodnosti', warning=FALSE}

lleto<-tabela$leto
plot(lleto,tabela$zivorojeni.na.1000, xlim=c(2010,2020),ylim=c(-100,300),
     xlab="Leto",ylab="Živorojeni na 1000 prebivalcev",
     main="Napoved rodnosti za SLovenijo",pch=20,col="lightblue",type="p",lwd=3.5)
linearna<-lm(tabela$zivorojeni.na.1000~lleto)
abline(linearna,col="red")
kvadratna<-lm(tabela$zivorojeni.na.1000~I(lleto^2)+lleto)
curve(predict(kvadratna, data.frame(lleto=x)), add = TRUE, col = "green")
loep<-loess(tabela$zivorojeni.na.1000~lleto)
curve(predict(loep, data.frame(lleto=x)),add=TRUE,col="blue")
legend("topright", c("Linerana metoda", "Kvadratna metoda","Loess"),lty=c(1,1,1), col = c("red","green","blue"))


```

Predstavljeni odatki zajemajo število živorojenih na 1000 prebivalcev skupaj po občinah. Graf prikazuje napoved rodnosti do leta 2010. Po izračunu razlike sem ugotovila, da je metoda loess najučinkovitejša. 
Iz grafa je razvidno, da bo rodnost naraščala.

```{r graf11, echo=FALSE,fig.align='center',fig.cap='Napoved umrlivosti', warning=FALSE}

lleto<-tabela$leto
plot(lleto,tabela$umrli.na.1000, xlim=c(2010,2020),ylim=c(-100,300),
     xlab="Leto",ylab="število umrlih na 1000 prebivalcev",
     main="Napoved umrlivosti za Slovenijo",pch=20,col="lightblue",type="p",lwd=3.5)
linearna<-lm(tabela$umrli.na.1000~lleto)
abline(linearna,col="red")
kvadratna<-lm(tabela$umrli.na.1000~I(lleto^2)+lleto)
curve(predict(kvadratna, data.frame(lleto=x)), add = TRUE, col = "green")
loep<-loess(tabela$umrli.na.1000~lleto)
curve(predict(loep, data.frame(lleto=x)),add=TRUE,col="blue")
legend("topright", c("Linerana metoda", "Kvadratna metoda","Loess"),lty=c(1,1,1), col = c("red","green","blue"))


```

Predstavljeni podatki zajemajo število umrlih na 1000 prebivalcev v vseh občinah, ločeno glede na leta. Iz grafa je razvidno, da linearna metoda napoveduje padec smrtnosti, kvadratna pa narast. Z izračunom ostankov pa ugotovimo, da je metoda loess najnatančnejša.